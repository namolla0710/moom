<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Moom</title>
    <style>
        :root {
            --primary-bg: #2c2f33;
            --secondary-bg: #23272a;
            --tertiary-bg: #40444b;
            --primary-accent: #7289da;
            --primary-accent-hover: #677bc4;
            --danger-accent: #f04747;
            --text-light: #ffffff;
            --text-muted: #99aab5;
        }
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            background-color: var(--primary-bg); 
            color: var(--text-light); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            justify-content: center; 
            align-items: center; 
        }
        
        /* --- ë¡œë¹„ ìŠ¤íƒ€ì¼ --- */
        #lobby { text-align: center; width: 90%; max-width: 900px; }
        .lobby-container { display: flex; flex-direction: column; justify-content: space-around; margin-top: 20px; gap: 40px; }
        #room-list-container, #create-room-form { background-color: var(--secondary-bg); padding: 25px; border-radius: 8px; flex: 1; }
        h1 { font-size: 2.5em; color: var(--primary-accent); }
        h2 { margin-top: 0; border-bottom: 1px solid var(--tertiary-bg); padding-bottom: 15px; }
        #room-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; text-align: left; }
        #room-list li { background-color: var(--tertiary-bg); margin-bottom: 10px; padding: 15px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        #room-list li:hover { background-color: #555b62; }
        #room-list .room-info span { margin-right: 15px; }
        #room-list .lock-icon { color: var(--text-muted); font-size: 1.2em; }
        #create-room-form input { display: block; width: calc(100% - 22px); font-size: 1.1em; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #555; background-color: var(--primary-bg); color: var(--text-light); }
        #create-join-btn { width: 100%; font-size: 1.2em; padding: 12px 20px; cursor: pointer; border-radius: 5px; border: none; background-color: var(--primary-accent); color: var(--text-light); transition: background-color 0.2s; }
        #create-join-btn:hover { background-color: var(--primary-accent-hover); }

        /* --- íšŒì˜ì‹¤ ìŠ¤íƒ€ì¼ --- */
        #meeting-room { display: none; width: 100%; height: 100%; flex-direction: column; }
        #header { padding: 10px; background-color: var(--secondary-bg); text-align: center; font-size: 1.2em; }
        #header span { font-weight: bold; color: var(--primary-accent); }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        #video-container { flex: 3; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; padding: 10px; background-color: var(--primary-bg); overflow-y: auto; }
        video { width: 100%; border-radius: 8px; background-color: #000; transform: scaleX(-1); }
        .video-wrapper { position: relative; }
        .video-wrapper p { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.9em; }
        #my-video-wrapper { border: 2px solid var(--primary-accent); border-radius: 10px; }
        #my-video-wrapper p { font-weight: bold; }
        #chat-container { flex: 1; display: flex; flex-direction: column; background-color: var(--secondary-bg); padding: 10px; min-width: 300px; }
        #chat-messages { flex-grow: 1; overflow-y: auto; border: 1px solid var(--tertiary-bg); padding: 10px; margin-bottom: 10px; list-style-type: none; }
        #chat-messages::-webkit-scrollbar { display: none; }
        #chat-messages li:not(.other-chat-pn) { margin-bottom: 8px; word-break: break-all; }
        .my-chat { text-align: right; background-color: var(--primary-accent); min-height: 2em; border-radius: 0.5em; padding: 0.5em 1em; display: flex; justify-content: flex-end; align-items: center; }
        .other-chat { text-align: left; background-color: var(--tertiary-bg); min-height: 2em; border-radius: 0.5em; padding: 0.5em 1em; display: flex; justify-content: flex-start; align-items: center; }
        .other-chat-pn { text-align: left; padding-left: 0.5em; margin-bottom: 4px; font-size: 0.9em; color: var(--text-muted); }
        #chat-form { display: flex; }
        #chat-input { flex-grow: 1; border: none; padding: 8px; background-color: var(--tertiary-bg); color: var(--text-light); }
        #controls { text-align: center; padding: 15px; background-color: var(--secondary-bg); }
        #controls button { background-color: var(--primary-accent); color: white; border: none; padding: 10px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        #controls button:hover { background-color: var(--primary-accent-hover); }
        #controls button.off { background-color: var(--danger-accent); }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>Moom</h1>
        <div class="lobby-container">
            <div id="room-list-container">
                <h2>í™œì„±í™”ëœ ë°© ëª©ë¡</h2>
                <ul id="room-list"></ul>
            </div>
            <div id="create-room-form">
                <h2>ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸° / ì…ì¥</h2>
                <input id="nickname-input" type="text" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                <input id="room-name-input" type="text" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                <input id="password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì—†ìœ¼ë©´ ê³µê°œ ë°©)">
                <button id="create-join-btn">ì…ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="meeting-room">
        <div id="header">í˜„ì¬ ë°©: <span id="room-name-display"></span></div>
        <div class="main-container">
            <div id="video-container">
                <div id="my-video-wrapper" class="video-wrapper">
                    <video id="my-video" autoplay muted></video>
                    <p id="my-nickname-display">ë‚˜ (You)</p>
                </div>
            </div>
            <div id="chat-container">
                <ul id="chat-messages"></ul>
                <form id="chat-form">
                    <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                </form>
            </div>
        </div>
        <div id="controls">
            <button id="mute-btn">ìŒì†Œê±°</button>
            <button id="camera-btn">ì¹´ë©”ë¼ ë„ê¸°</button>
            <button id="share-screen-btn">í™”ë©´ ê³µìœ </button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // -----------------
        // 1. ì´ˆê¸° ì„¤ì • ë° ë³€ìˆ˜ ì„ ì–¸
        // -----------------
        console.log("ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘. ì„œë²„ì— ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");
        // âœ¨ ë°°í¬ í™˜ê²½ì—ì„œ ì•ˆì •ì ì¸ ì—°ê²°ì„ ìœ„í•´ ì›¹ì†Œì¼“ì„ ìš°ì„  ì‚¬ìš©í•˜ë„ë¡ ëª…ì‹œ
        const socket = io({ transports: ['websocket'] });

        // DOM ìš”ì†Œ
        const lobby = document.getElementById('lobby');
        const nicknameInput = document.getElementById('nickname-input');
        const roomNameInput = document.getElementById('room-name-input');
        const passwordInput = document.getElementById('password-input');
        const createJoinBtn = document.getElementById('create-join-btn');
        const roomList = document.getElementById('room-list');
        const meetingRoom = document.getElementById('meeting-room');
        const roomNameDisplay = document.getElementById('room-name-display');
        const myNicknameDisplay = document.getElementById('my-nickname-display');
        const videoContainer = document.getElementById('video-container');
        const myVideo = document.getElementById('my-video');
        const muteBtn = document.getElementById('mute-btn');
        const cameraBtn = document.getElementById('camera-btn');
        const shareScreenBtn = document.getElementById('share-screen-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        // ìƒíƒœ ë³€ìˆ˜
        let myStream, peerConnections = {}, peerNicknames = {}, myNickname, currentRoomName;
        let isMuted = false, isCameraOff = false, isScreenSharing = false;
        let isStreamReady = false, pendingPeers = [], pendingOffers = [];

        // WebRTC STUN ë° TURN ì„œë²„ ì„¤ì •
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
                { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
            ]
        };

        // -----------------
        // 2. ë¡œë¹„ ê¸°ëŠ¥ ê´€ë ¨ ë¡œì§
        // -----------------

        function attemptToJoinRoom(nickname, roomName, password = "") {
            console.log(`[Lobby] '${roomName}' ë°© ì…ì¥ì„ ì‹œë„í•©ë‹ˆë‹¤. ë‹‰ë„¤ì„: ${nickname}`);
            if (!nickname) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if (!roomName) { alert("ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            socket.emit('join', { nickname, room_name: roomName, password });
        }

        createJoinBtn.addEventListener('click', () => {
            attemptToJoinRoom(nicknameInput.value.trim(), roomNameInput.value.trim(), passwordInput.value);
        });

        socket.on('update_room_list', (rooms) => {
            console.log("[Lobby] ë°© ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.", rooms);
            roomList.innerHTML = "";
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.dataset.roomName = room.name;
                li.dataset.hasPassword = room.has_password;
                const roomInfo = document.createElement('div');
                roomInfo.className = 'room-info';
                roomInfo.innerHTML = `<span><span class="math-inline">${room.name}</span><span>(</span>${room.user_count}ëª…)</span>`;
                li.appendChild(roomInfo);
                if (room.has_password) {
                    const lockIcon = document.createElement('span');
                    lockIcon.className = 'lock-icon';
                    lockIcon.textContent = 'ğŸ”’';
                    li.appendChild(lockIcon);
                }
                li.addEventListener('click', () => {
                    const nickname = nicknameInput.value.trim();
                    if (!nickname) { alert("ë¨¼ì € ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                    let password = "";
                    if (room.has_password) {
                        password = prompt(`'${room.name}' ë°©ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
                        if (password === null) return;
                    }
                    attemptToJoinRoom(nickname, room.name, password);
                });
                roomList.appendChild(li);
            });
        });

        socket.on('join_failed', (data) => {
            console.error("[Lobby] ë°© ì…ì¥ ì‹¤íŒ¨:", data.message);
            alert(data.message);
        });

        socket.on('join_success', async (data) => {
            console.log("[Core] ë°© ì…ì¥ ì„±ê³µ! ë°©:", data.room);
            currentRoomName = data.room;
            myNickname = data.nickname;
            lobby.style.display = 'none';
            meetingRoom.style.display = 'flex';
            roomNameDisplay.textContent = currentRoomName;
            myNicknameDisplay.textContent = `${myNickname} (ë‚˜)`;
            data.existing_users.forEach(user => {
                console.log(`[Core] ê¸°ì¡´ ìœ ì € ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤: <span class="math-inline">\{user\.nickname\}\(</span>{user.sid})`);
                peerNicknames[user.sid] = user.nickname;
            });
            try {
                console.log("[Media] ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì„ ì‹œì‘í•©ë‹ˆë‹¤...");
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                myVideo.srcObject = myStream;
                console.log("[Media] âœ… ì¹´ë©”ë¼/ë§ˆì´í¬ ì¤€ë¹„ ì™„ë£Œ!");
                isStreamReady = true;
                console.log("[Queue] ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ë“¤ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤...");
                if (pendingPeers.length > 0) {
                    console.log("[Queue] ëŒ€ê¸° ì¤‘ì¸ ìœ ì €ë“¤ì„ ì—°ê²°í•©ë‹ˆë‹¤:", pendingPeers);
                    pendingPeers.forEach(peerSid => handleUserJoined({ sid: peerSid }));
                    pendingPeers = [];
                }
                if (pendingOffers.length > 0) {
                    console.log("[Queue] ëŒ€ê¸° ì¤‘ì¸ Offerì— ì‘ë‹µí•©ë‹ˆë‹¤:", pendingOffers.map(o => o.from_sid));
                    pendingOffers.forEach(offerData => handleOffer(offerData));
                    pendingOffers = [];
                }
                console.log("[Queue] ëª¨ë“  ëŒ€ê¸° ì‘ì—… ì²˜ë¦¬ ì™„ë£Œ.");
            } catch (e) {
                console.error("[Media] âŒ ë¯¸ë””ì–´ ì¥ì¹˜ ì ‘ê·¼ ì˜¤ë¥˜:", e);
                alert("ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
            }
        });

        // -----------------
        // 3. WebRTC ë° ì‹œê·¸ë„ë§ ë¡œì§
        // -----------------

        socket.on('user-joined', (data) => {
            console.log(`[Signal] ìƒˆë¡œìš´ ìœ ì € ì…ì¥ ì‹ í˜¸ ìˆ˜ì‹ : <span class="math-inline">\{data\.nickname\}\(</span>{data.sid})`);
            peerNicknames[data.sid] = data.nickname;
            if (!isStreamReady) {
                console.warn(`[Queue] ë‚´ ìŠ¤íŠ¸ë¦¼ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•„, ìœ ì €(${data.sid})ë¥¼ ëŒ€ê¸°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤.`);
                pendingPeers.push(data.sid);
                return;
            }
            handleUserJoined(data);
        });

        async function handleUserJoined({ sid }) {
            console.log(`[WebRTC] â¡ï¸ Offer ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤. ëŒ€ìƒ: <span class="math-inline">\{peerNicknames\[sid\]\}\(</span>{sid})`);
            const pc = createPeerConnection(sid);
            if (!pc) { console.error("[WebRTC] â¡ï¸ PeerConnection ìƒì„± ì‹¤íŒ¨ë¡œ Offer ìƒì„±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."); return; }
            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                console.log(`[WebRTC] â¡ï¸ Offer ìƒì„± ë° LocalDescription ì„¤ì • ì™„ë£Œ. ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.`);
                socket.emit('offer', { target_sid: sid, from_sid: socket.id, offer });
            } catch (error) {
                console.error(`[WebRTC] â¡ï¸ Offer ìƒì„± ì¤‘ ì˜¤ë¥˜:`, error);
            }
        }

        socket.on('offer', (data) => {
            console.log(`[Signal] Offer ì‹ í˜¸ ìˆ˜ì‹ . ë³´ë‚¸ ì‚¬ëŒ: ${data.from_sid}`);
            if (!isStreamReady) {
                console.warn(`[Queue] ë‚´ ìŠ¤íŠ¸ë¦¼ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•„, Offerë¥¼ ëŒ€ê¸°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤.`);
                pendingOffers.push(data);
                return;
            }
            handleOffer(data);
        });

        async function handleOffer(data) {
            console.log(`[WebRTC] â¬…ï¸ Answer ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤. ë³´ë‚¸ ì‚¬ëŒ: <span class="math-inline">\{peerNicknames\[data\.from\_sid\]\}\(</span>{data.from_sid})`);
            const pc = createPeerConnection(data.from_sid);
            if (!pc) { console.error("[WebRTC] â¬…ï¸ PeerConnection ìƒì„± ì‹¤íŒ¨ë¡œ Answer ìƒì„±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."); return; }
            try {
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                console.log(`[WebRTC] â¬…ï¸ Answer ìƒì„± ë° LocalDescription ì„¤ì • ì™„ë£Œ. ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.`);
                socket.emit('answer', { target_sid: data.from_sid, from_sid: socket.id, answer });
            } catch (error) {
                console.error(`[WebRTC] â¬…ï¸ Answer ìƒì„± ì¤‘ ì˜¤ë¥˜:`, error);
            }
        }

        socket.on('answer', async (data) => {
            console.log(`[Signal] Answer ì‹ í˜¸ ìˆ˜ì‹ . ë³´ë‚¸ ì‚¬ëŒ: <span class="math-inline">\{peerNicknames\[data\.from\_sid\]\}\(</span>{data.from_sid})`);
            const pc = peerConnections[data.from_sid];
            if (pc) {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    console.log(`[WebRTC] âœ… Answer ì ìš© ì™„ë£Œ: ${peerNicknames[data.from_sid]}`);
                } catch (error) {
                    console.error(`[WebRTC] âŒ Answer ì ìš© ì¤‘ ì˜¤ë¥˜:`, error);
                }
            }
        });

        socket.on('ice-candidate', (data) => {
            const pc = peerConnections[data.from_sid];
            if (pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        });

        socket.on('user-left', (data) => {
            const nickname = peerNicknames[data.sid] || data.sid.substring(0, 5);
            console.log(`[Signal] ìœ ì € í‡´ì¥ ì‹ í˜¸ ìˆ˜ì‹ : <span class="math-inline">\{nickname\}\(</span>{data.sid})`);
            if (peerConnections[data.sid]) {
                peerConnections[data.sid].close();
                delete peerConnections[data.sid];
            }
            delete peerNicknames[data.sid];
            const videoElement = document.getElementById(`video-${data.sid}`);
            if (videoElement) videoElement.parentElement.remove();
        });

        function createPeerConnection(sid) {
            if (!myStream) {
                console.error("[WebRTC] createPeerConnection í˜¸ì¶œ ì‹œ ë‚´ ìŠ¤íŠ¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                return null;
            }
            console.log(`[WebRTC] PeerConnection ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ëŒ€ìƒ: ${sid}`);
            const pc = new RTCPeerConnection(configuration);
            peerConnections[sid] = pc;
            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));
            pc.onicecandidate = (event) => {
                if (event.candidate) socket.emit('ice-candidate', { target_sid: sid, from_sid: socket.id, candidate: event.candidate });
            };
            pc.ontrack = (event) => {
                console.log(`[WebRTC] ì›ê²© íŠ¸ë™ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ëŒ€ìƒ: ${sid}`);
                let videoElement = document.getElementById(`video-${sid}`);
                if (!videoElement) {
                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = 'video-wrapper';
                    videoElement = document.createElement('video');
                    videoElement.id = `video-${sid}`;
                    videoElement.autoplay = true;
                    videoElement.playsInline = true;
                    const nameTag = document.createElement('p');
                    nameTag.textContent = peerNicknames[sid] || sid.substring(0, 5);
                    videoWrapper.appendChild(videoElement);
                    videoWrapper.appendChild(nameTag);
                    videoContainer.appendChild(videoWrapper);
                }
                videoElement.srcObject = event.streams[0];
            };
            return pc;
        }

        // -----------------
        // 4. ë¶€ê°€ ê¸°ëŠ¥ (ì±„íŒ…, ë¯¸ë””ì–´ ì œì–´)
        // -----------------
        socket.on('chat', (data) => {
            const item = document.createElement('li');
            item.textContent = data.message;
            item.className = data.from_sid === socket.id ? 'my-chat' : 'other-chat';
            if(data.from_sid !== socket.id){
                const nameItem = document.createElement('li');
                nameItem.textContent = data.nickname;
                nameItem.className = 'other-chat-pn';
                chatMessages.appendChild(nameItem);
            }
            chatMessages.appendChild(item);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value;
            if (message && currentRoomName) {
                socket.emit('chat', { room: currentRoomName, message: message });
                chatInput.value = '';
            }
        });

        muteBtn.addEventListener('click', () => { if(myStream) { isMuted = !isMuted; myStream.getAudioTracks()[0].enabled = !isMuted; muteBtn.textContent = isMuted ? 'ìŒì†Œê±° í•´ì œ' : 'ìŒì†Œê±°'; muteBtn.classList.toggle('off', isMuted); }});
        cameraBtn.addEventListener('click', () => { if(myStream) { isCameraOff = !isCameraOff; myStream.getVideoTracks()[0].enabled = !isCameraOff; cameraBtn.textContent = isCameraOff ? 'ì¹´ë©”ë¼ ì¼œê¸°' : 'ì¹´ë©”ë¼ ë„ê¸°'; cameraBtn.classList.toggle('off', isCameraOff); }});

        shareScreenBtn.addEventListener('click', async () => {
            if (!myStream) return;
            if (isScreenSharing) {
                try {
                    const newWebcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const newWebcamTrack = newWebcamStream.getVideoTracks()[0];
                    const currentAudioTrack = myStream.getAudioTracks()[0];
                    
                    const newStream = new MediaStream([newWebcamTrack, currentAudioTrack]);
                    myVideo.srcObject = newStream;
                    myStream.getVideoTracks()[0].stop();
                    myStream.removeTrack(myStream.getVideoTracks()[0]);
                    myStream.addTrack(newWebcamTrack);

                    for (const sid in peerConnections) {
                        const sender = peerConnections[sid].getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) await sender.replaceTrack(newWebcamTrack);
                    }
                    shareScreenBtn.textContent = 'í™”ë©´ ê³µìœ ';
                    isScreenSharing = false;
                } catch (e) { console.error("ì›¹ìº ìœ¼ë¡œ ëŒì•„ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", e); }
            } else {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    const currentAudioTrack = myStream.getAudioTracks()[0];

                    myVideo.srcObject = new MediaStream([screenTrack, currentAudioTrack]);
                    
                    const currentVideoTrack = myStream.getVideoTracks()[0];
                    myStream.removeTrack(currentVideoTrack);
                    myStream.addTrack(screenTrack);
                    
                    for (const sid in peerConnections) {
                        const sender = peerConnections[sid].getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) await sender.replaceTrack(screenTrack);
                    }
                    screenTrack.onended = () => { if (isScreenSharing) shareScreenBtn.click(); };
                    shareScreenBtn.textContent = 'ê³µìœ  ì¤‘ì§€';
                    isScreenSharing = true;
                } catch (e) { console.error("í™”ë©´ ê³µìœ  ì‹¤íŒ¨:", e); }
            }
        });
    </script>
</body>
</html>