<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Moom</title>
    <style>
        :root {
            --primary-bg: #2c2f33;
            --secondary-bg: #23272a;
            --tertiary-bg: #40444b;
            --primary-accent: #7289da;
            --primary-accent-hover: #677bc4;
            --danger-accent: #f04747;
            --text-light: #ffffff;
            --text-muted: #99aab5;
        }
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            background-color: var(--primary-bg); 
            color: var(--text-light); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            justify-content: center; 
            align-items: center; 
        }
        
        /* --- 로비 스타일 --- */
        #lobby { text-align: center; width: 90%; max-width: 900px; }
        .lobby-container { display: flex; flex-direction: column; justify-content: space-around; margin-top: 20px; gap: 40px; }
        #room-list-container, #create-room-form { background-color: var(--secondary-bg); padding: 25px; border-radius: 8px; flex: 1; }
        h1 { font-size: 2.5em; color: var(--primary-accent); }
        h2 { margin-top: 0; border-bottom: 1px solid var(--tertiary-bg); padding-bottom: 15px; }
        #room-list { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; text-align: left; }
        #room-list li { background-color: var(--tertiary-bg); margin-bottom: 10px; padding: 15px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        #room-list li:hover { background-color: #555b62; }
        #room-list .room-info span { margin-right: 15px; }
        #room-list .lock-icon { color: var(--text-muted); font-size: 1.2em; }
        #create-room-form input { display: block; width: calc(100% - 22px); font-size: 1.1em; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #555; background-color: var(--primary-bg); color: var(--text-light); }
        #create-join-btn { width: 100%; font-size: 1.2em; padding: 12px 20px; cursor: pointer; border-radius: 5px; border: none; background-color: var(--primary-accent); color: var(--text-light); transition: background-color 0.2s; }
        #create-join-btn:hover { background-color: var(--primary-accent-hover); }

        /* --- 회의실 스타일 --- */
        #meeting-room { display: none; width: 100%; height: 100%; flex-direction: column; }
        #header { padding: 10px; background-color: var(--secondary-bg); text-align: center; font-size: 1.2em; }
        #header span { font-weight: bold; color: var(--primary-accent); }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        #video-container { flex: 3; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; padding: 10px; background-color: var(--primary-bg); overflow-y: auto; }
        video { width: 100%; border-radius: 8px; background-color: #000; transform: scaleX(-1); }
        .video-wrapper { position: relative; }
        .video-wrapper p { position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.9em; }
        #my-video-wrapper { border: 2px solid var(--primary-accent); border-radius: 10px; }
        #my-video-wrapper p { font-weight: bold; }
        #chat-container { flex: 1; display: flex; flex-direction: column; background-color: var(--secondary-bg); padding: 10px; min-width: 300px; }
        #chat-messages { flex-grow: 1; overflow-y: auto; border: 1px solid var(--tertiary-bg); padding: 10px; margin-bottom: 10px; list-style-type: none; }
        #chat-messages::-webkit-scrollbar { display: none; }
        #chat-messages li:not(.other-chat-pn) { margin-bottom: 8px; word-break: break-all; }
        .my-chat { text-align: right; background-color: var(--primary-accent); min-height: 2em; border-radius: 0.5em; padding: 0.5em 1em; display: flex; justify-content: flex-end; align-items: center; }
        .other-chat { text-align: left; background-color: var(--tertiary-bg); min-height: 2em; border-radius: 0.5em; padding: 0.5em 1em; display: flex; justify-content: flex-start; align-items: center; }
        .other-chat-pn { text-align: left; padding-left: 0.5em; margin-bottom: 4px; font-size: 0.9em; color: var(--text-muted); }
        #chat-form { display: flex; }
        #chat-input { flex-grow: 1; border: none; padding: 8px; background-color: var(--tertiary-bg); color: var(--text-light); }
        #controls { text-align: center; padding: 15px; background-color: var(--secondary-bg); }
        #controls button { background-color: var(--primary-accent); color: white; border: none; padding: 10px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        #controls button:hover { background-color: var(--primary-accent-hover); }
        #controls button.off { background-color: var(--danger-accent); }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>Moom</h1>
        <div class="lobby-container">
            <div id="room-list-container">
                <h2>활성화된 방 목록</h2>
                <ul id="room-list"></ul>
            </div>
            <div id="create-room-form">
                <h2>새로운 방 만들기 / 입장</h2>
                <input id="nickname-input" type="text" placeholder="사용할 닉네임을 입력하세요" required>
                <input id="room-name-input" type="text" placeholder="방 이름을 입력하세요" required>
                <input id="password-input" type="password" placeholder="비밀번호 (없으면 공개 방)">
                <button id="create-join-btn">입장하기</button>
            </div>
        </div>
    </div>

    <div id="meeting-room">
        <div id="header">현재 방: <span id="room-name-display"></span></div>
        <div class="main-container">
            <div id="video-container">
                <div id="my-video-wrapper" class="video-wrapper">
                    <video id="my-video" autoplay muted></video>
                    <p id="my-nickname-display">나 (You)</p>
                </div>
            </div>
            <div id="chat-container">
                <ul id="chat-messages"></ul>
                <form id="chat-form">
                    <input id="chat-input" type="text" placeholder="메시지를 입력하세요..." autocomplete="off">
                </form>
            </div>
        </div>
        <div id="controls">
            <button id="mute-btn">음소거</button>
            <button id="camera-btn">카메라 끄기</button>
            <button id="share-screen-btn">화면 공유</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
 <script>
        // -----------------
        // 1. 초기 설정 및 변수 선언
        // -----------------
        console.log("스크립트 시작");
        const socket = io({ transports: ['websocket'] });

        // DOM 요소
        const lobby = document.getElementById('lobby'), meetingRoom = document.getElementById('meeting-room');
        const nicknameInput = document.getElementById('nickname-input'), roomNameInput = document.getElementById('room-name-input');
        const createJoinBtn = document.getElementById('create-join-btn'), roomList = document.getElementById('room-list');
        const roomNameDisplay = document.getElementById('room-name-display'), myNicknameDisplay = document.getElementById('my-nickname-display');
        const videoContainer = document.getElementById('video-container'), myVideo = document.getElementById('my-video');
        const muteBtn = document.getElementById('mute-btn'), cameraBtn = document.getElementById('camera-btn');
        const shareScreenBtn = document.getElementById('share-screen-btn'), changeNicknameBtn = document.getElementById('change-nickname-btn');
        const chatForm = document.getElementById('chat-form'), chatInput = document.getElementById('chat-input'), chatMessages = document.getElementById('chat-messages');
        const myMuteIcon = document.getElementById('my-mute-icon'), myCameraOffIcon = document.getElementById('my-camera-off-icon');

        // 상태 변수
        let myStream, peerConnections = {}, peerNicknames = {}, myNickname, currentRoomName;
        let isMuted = false, isCameraOff = false, isScreenSharing = false;
        let isStreamReady = false, pendingPeers = [], pendingOffers = [];

        // WebRTC STUN 및 TURN 서버 설정
        const configuration = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }, { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' } ] };

        // -----------------
        // 2. 로비 및 입장 로직
        // -----------------
        function attemptToJoinRoom(nickname, roomName, password = "") { /* 이전과 동일 */ }
        createJoinBtn.addEventListener('click', () => { attemptToJoinRoom(nicknameInput.value.trim(), roomNameInput.value.trim(), passwordInput.value); });
        socket.on('update_room_list', (rooms) => { /* 이전과 동일 */ });
        socket.on('join_failed', (data) => alert(data.message));

        socket.on('join_success', async (data) => {
            console.log("[Core] 방 입장 성공! 방:", data.room);
            currentRoomName = data.room;
            myNickname = data.nickname;
            lobby.style.display = 'none';
            meetingRoom.style.display = 'flex';
            roomNameDisplay.textContent = currentRoomName;
            myNicknameDisplay.textContent = `${myNickname} (나)`;

            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                myVideo.srcObject = myStream;
                isStreamReady = true;

                // ✨ 2인 즉시 연결 로직: 새로 들어온 사람이 기존 유저들에게 연결을 시작
                console.log("[WebRTC] 기존 유저들에게 연결을 시작합니다.", data.existing_users);
                data.existing_users.forEach(user => {
                    peerNicknames[user.sid] = user.nickname;
                    handleUserJoined({ sid: user.sid });
                });

            } catch (e) {
                console.error("미디어 장치 접근 오류:", e);
                alert("카메라/마이크 접근 권한을 허용해주세요.");
            }
        });

        // -----------------
        // 3. WebRTC 및 시그널링 로직
        // -----------------

        // ✨ 'user-joined'는 더 이상 연결 시작에 사용되지 않고, 닉네임 목록 갱신용으로만 사용
        socket.on('user-joined-info', (data) => {
            console.log(`[Info] 새로운 유저 정보 수신: ${data.nickname}(${data.sid})`);
            peerNicknames[data.sid] = data.nickname;
        });

        async function handleUserJoined({ sid }) { /* 이전과 동일 */ }
        socket.on('offer', (data) => { handleOffer(data); }); // 대기열 로직 제거 (2인 연결 로직으로 불필요해짐)
        async function handleOffer(data) { /* 이전과 거의 동일 */ }
        socket.on('answer', async (data) => { /* 이전과 동일 */ });
        socket.on('ice-candidate', (data) => { /* 이전과 동일 */ });
        socket.on('user-left', (data) => { /* 이전과 동일 */ });

        function createPeerConnection(sid) {
            if (!myStream) return null;
            const pc = new RTCPeerConnection(configuration);
            peerConnections[sid] = pc;
            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));
            pc.onicecandidate = (event) => { /* ... */ };
            pc.ontrack = (event) => {
                let videoElement = document.getElementById(`video-${sid}`);
                if (!videoElement) {
                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = 'video-wrapper';
                    videoWrapper.innerHTML = `
                        <video id="video-${sid}" autoplay playsinline></video>
                        <div id="mute-icon-${sid}" class="status-icon">🔇</div>
                        <div id="camera-off-icon-${sid}" class="status-icon">📷</div>
                        <p>${peerNicknames[sid] || sid.substring(0, 5)}</p>
                    `;
                    videoContainer.appendChild(videoWrapper);
                }
                document.getElementById(`video-${sid}`).srcObject = event.streams[0];
            };
            return pc;
        }

        // -----------------
        // 4. 새로운 기능 (닉네임 변경, 상태 표시)
        // -----------------

        // 닉네임 변경 버튼 클릭
        changeNicknameBtn.addEventListener('click', () => {
            const newNickname = prompt("새로운 닉네임을 입력하세요:", myNickname);
            if (newNickname && newNickname.trim() !== "") {
                myNickname = newNickname.trim();
                myNicknameDisplay.textContent = `${myNickname} (나)`;
                socket.emit('change_nickname', { room: currentRoomName, new_nickname: myNickname });
            }
        });

        // 다른 사람의 닉네임이 변경되었다는 신호 수신
        socket.on('nickname_changed', (data) => {
            console.log(`[Info] 닉네임 변경됨: ${data.sid} -> ${data.new_nickname}`);
            peerNicknames[data.sid] = data.new_nickname;
            const nameTag = document.querySelector(`#video-${data.sid} + p`);
            if (nameTag) {
                nameTag.textContent = data.new_nickname;
            }
        });

        // 다른 사람의 미디어 상태가 변경되었다는 신호 수신
        socket.on('user_media_status_changed', (data) => {
            const { sid, mediaType, status } = data;
            console.log(`[Status] 상태 변경: ${peerNicknames[sid]}의 ${mediaType} -> ${status}`);
            const icon = document.getElementById(`${mediaType === 'audio' ? 'mute' : 'camera-off'}-icon-${sid}`);
            if (icon) {
                icon.style.display = status ? 'block' : 'none';
            }
        });

        // -----------------
        // 5. 부가 기능 (채팅, 미디어 제어)
        // -----------------
        
        // ✨ 음소거/카메라 버튼 클릭 시 상태 변경 신호 전송
        muteBtn.addEventListener('click', () => {
            if (!myStream) return;
            isMuted = !isMuted;
            myStream.getAudioTracks()[0].enabled = !isMuted;
            muteBtn.textContent = isMuted ? '음소거 해제' : '음소거';
            muteBtn.classList.toggle('off', isMuted);
            myMuteIcon.style.display = isMuted ? 'block' : 'none';
            socket.emit('media_status_change', { room: currentRoomName, mediaType: 'audio', status: isMuted });
        });

        cameraBtn.addEventListener('click', () => {
            if (!myStream) return;
            isCameraOff = !isCameraOff;
            myStream.getVideoTracks()[0].enabled = !isCameraOff;
cameraBtn.textContent = isCameraOff ? '카메라 켜기' : '카메라 끄기';
            cameraBtn.classList.toggle('off', isCameraOff);
            myCameraOffIcon.style.display = isCameraOff ? 'block' : 'none';
            socket.emit('media_status_change', { room: currentRoomName, mediaType: 'video', status: isCameraOff });
        });
        
        // ✨ 화면 공유 시 소리 포함 요청
        shareScreenBtn.addEventListener('click', async () => {
            if (!myStream) return;
            if (isScreenSharing) {
                // ... 화면 공유 중지 로직 (이전과 동일) ...
            } else {
                try {
                    // getDisplayMedia에 audio: true 추가
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    
                    const screenVideoTrack = screenStream.getVideoTracks()[0];
                    // 화면 공유 시 오디오 트랙이 있는지 확인하고 교체
                    const screenAudioTrack = screenStream.getAudioTracks()[0];

                    myVideo.srcObject = screenStream;

                    // 비디오 트랙 교체
                    const videoSender = peerConnections[Object.keys(peerConnections)[0]]?.getSenders().find(s => s.track?.kind === 'video');
                    if (videoSender) await videoSender.replaceTrack(screenVideoTrack);
                    
                    // 오디오 트랙 교체 (화면 소리가 있을 경우)
                    if (screenAudioTrack) {
                        const audioSender = peerConnections[Object.keys(peerConnections)[0]]?.getSenders().find(s => s.track?.kind === 'audio');
                        if (audioSender) await audioSender.replaceTrack(screenAudioTrack);
                    }
                    
                    screenTrack.onended = () => { if (isScreenSharing) shareScreenBtn.click(); };
                    shareScreenBtn.textContent = '공유 중지';
                    isScreenSharing = true;
                } catch (e) { console.error("화면 공유 실패:", e); }
            }
        });
    </script>
</body>
</html>